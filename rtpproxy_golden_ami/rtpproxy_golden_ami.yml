---
Resources:

  SSHFromAnywhereSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      VpcId: !ImportValue vpc-stack:MyVPC
      GroupDescription: Allow SIP from anywhere
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort : 22
          ToPort : 22
          CidrIp: 0.0.0.0/0

  RtpProxyGoldenInstance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: ami-0ba5191a708339a31
      InstanceType: t2.micro
      SubnetId: !ImportValue vpc-stack:PublicSubnet1
      KeyName: 2020key
      SecurityGroupIds:
        - !Ref SSHFromAnywhereSG
      UserData:
        Fn::Base64:
          !Sub |
            #!/bin/bash -xe
            apt-get update -y
            apt-get install -y build-essential libjansson-dev

            (cd /usr/local/src/rtpproxy && git clone -b master https://github.com/sippy/rtpproxy.git && git -C rtpproxy submodule update --init --recursive && ./configure && make)

            (cd /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.d && wget https://raw.githubusercontent.com/dpaquette77/aws-voip/master/rtpproxy_golden_ami/config.json)

            apt-get install -y collectd

            systemctl enable amazon-cloudwatch-agent

            systemctl enable rtpproxy
