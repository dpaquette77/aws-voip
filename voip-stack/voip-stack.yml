---
Resources:
  OpenSipsInstanceProfile:
    Type: 'AWS::IAM::InstanceProfile'
    Properties:
      Path: /
      Roles:
        - !ImportValue security-stack:AutomationServiceRole 

  SipRegistrarDnsRecordSet:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: Z2ZYCU8574UYOA
      Name: sip.dpaquette.net
      Type: A
      TTL: 60
      ResourceRecords:
        - !GetAtt OpenSipsInstance.PublicIp

  OpenSipsInstance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: '{{resolve:ssm:opensips-registrar-ami-latest:1}}'
      InstanceType: t2.micro
      SubnetId: !ImportValue vpc-stack:PublicSubnet1
      KeyName: 2020key
      SecurityGroupIds:
        - !ImportValue security-stack:SipRegistrarSG
        - !ImportValue security-stack:SSHFromAnywhereSG
      IamInstanceProfile: !Ref OpenSipsInstanceProfile
      UserData:
        Fn::Base64:
          !Sub |
            #!/bin/bash -xe
            pip install boto3
            wget https://raw.githubusercontent.com/dpaquette77/aws-voip/master/voip-stack/opensips.cfg -O /usr/local/etc/opensips/opensips.cfg
            wget https://raw.githubusercontent.com/dpaquette77/aws-voip/master/voip-stack/configure_opensips_db_url.py -O /tmp/configure_opensips_db_url.py
            python /tmp/configure_opensips_db_url.py
            sed -i "s/PUBLIC_IP/`curl http://169.254.169.254/latest/meta-data/public-ipv4`/g" /usr/local/etc/opensips/opensips.cfg
            sed -i "s/PRIVATE_IP/`curl http://169.254.169.254/latest/meta-data/local-ipv4`/g" /usr/local/etc/opensips/opensips.cfg
            /usr/local/sbin/opensipsctl start



  MediaServerInstanceProfile:
    Type: 'AWS::IAM::InstanceProfile'
    Properties:
      Path: /
      Roles:
        - !ImportValue security-stack:AutomationServiceRole


  MediaServerInstance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: '{{resolve:ssm:asterisk-ami-latest:1}}'
      InstanceType: t2.micro
      SubnetId: !ImportValue vpc-stack:PublicSubnet1
      KeyName: 2020key
      SecurityGroupIds:
        - !ImportValue security-stack:MediaServerSG
        - !ImportValue security-stack:SSHFromAnywhereSG
      IamInstanceProfile: !Ref MediaServerInstanceProfile

  RTPGatewayInstanceProfile:
    Type: 'AWS::IAM::InstanceProfile'
    Properties:
      Path: /
      Roles:
        - !ImportValue security-stack:AutomationServiceRole

  RTPGatewayInstance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: ami-0ba5191a708339a31
      InstanceType: t2.micro
      SubnetId: !ImportValue vpc-stack:PublicSubnet1
      KeyName: 2020key
      SecurityGroupIds:
        - !ImportValue security-stack:RTPGatewaySG
        - !ImportValue security-stack:SSHFromAnywhereSG
      IamInstanceProfile: !Ref RTPGatewayInstanceProfile
      UserData:
        Fn::Base64:
          !Sub |
            #!/bin/bash -xe
            apt-get update -y
            apt-get -y install rtpproxy
